---
layout:     post
title:      IIC总线的原理与verilog实现
subtitle:   
date:       2019-07-01
author:     yzmb2411
header-img: 
catalog: 	 true
tags:
    - FPGA
    - 无线通信 
---

## 1、原理介绍

IIC总线(Inter-Integrated Circuit，集成电路总线)，是两线式串行数据总线，它是同步通信的一种特殊形式，具有接口少、控制方式简单、器件封装形式小及通信速率较高等优点。

IIC总线有两根双向信号线——串行数据线（SDA）和串行时钟线（SCL）。所有的IIC总线上的器件的数据线都会连接到SDA，时钟线都会连接到SCL。IIC是一个多主设备总线，总线可以有一个或者多个主机，总线运行由主机控制。每一个器件都有一个唯一的识别地址，而且都可以用来作为一个发送器或接收器。主机是初始化总线的数据传输并产生时钟信号的器件。此时任何被寻址的设备都被称为从机。如果两个或者更多主机同时尝试初始化数据传输，总线可以通过冲突检测或者仲裁防止数据被破坏。IIC时钟频率不高于400K

IIC总线上的SDA和SCL是双向的。为了避免总线信号的混乱，要求设备连接到总线的输出时必须是漏极或者集电极开路。总线空闲时，上拉电阻使SDA和SCL线均为高电平，任一设备输出低电平将使得相应的总线信号变低，也就是说各设备SDA和SCL都是“与”的关系，这也使得IIC总线上不同速率的器件能够进行同步。

IIC数据传输速率有标准模式（100 kbps）、快速模式（400 kbps）和高速模式（3.4 Mbps），另外一些变种实现了低速模式（10 kbps）和快速+模式（1 Mbps）。

### IIC总线的特点

 - 1、简单性和有效性。由于接口直接在组件之上，因此I2C总线占用的空间非常小，减少了电路板的空间和芯片管脚的数量，降低了互联成本。总线的长度可高达25英尺，并且能够以10Kbps的最大传输速率支持40个组件。

 - 2、支持多主控(multimastering)， 其中任何能够进行发送和接收的设备都可以成为主总线。一个主控能够控制信号的传输和时钟频率。当然，在任何时间点上只能有一个主控占用IIC总线。

### IIC总线协议讲解

IIC总线接口是一个标准的双向传输接口，一次数据传输需要主机和从机按照IIC协议的标准进行。I2C总线是由数据线SDA和时钟SCL构成的串行总线，可发送和接收数据，并且在硬件上都需要接一个上拉电阻到VCC。各种被控制电路均并联在这条总线上，但就像电话机一样只有拨通各自的号码才能工作，所以每个电路和模块都有唯一的地址，这样，各控制电路虽然挂在同一条总线上，却彼此独立，互不相关。

IIC主机往从机里面写入数据的步骤如下：

 - 1、 主机发送一个起始信号和从机的设备地址给从机

 - 2、 主机发送数据给从机

 - 3、 主机发送一个停止信号结束发送过程

IIC主机从从机里面读出数据的步骤如下：

 - 1、 主机发送一个起始信号和从机的设备地址给从机

 - 2、 主机发送一个要读取的地址给从机

 - 3、 主机从从机接收数据

 - 4、 主机发送一个停止信号给从机结束整个接收过程 
 
IIC总线在通信的过程中一共有一下几种状态：

 - 1、空闲状态

IIC 总线的 SDA 和 SCL 两条信号线同时处于高电平时，规定为总线的空闲状态。此时各个器件的输出级场效应管均处在截止状态，即释放总线，由两条信号线各自的上拉电阻把电平拉高。

 - 2、起始状态和结束状态

在时钟线 SCL 保持高电平期间，数据线 SDA 上的电平被拉低(即下降沿)，定义为 I2C 总线总线的起始信号，它标志着一次数据传输的开始。起始信号是由主控器主动建立的，在建立该信号之前 I2C 总线必须处于空闲状态。

在时钟线 SCL 保持高电平期间，数据线 SDA 被释放，使得 SDA 返回高电平(即正跳变)，称为 I2C 总线的停止信号，它标志着一次数据传输的终止。停止信号也是由主控器主动建立的，建立该信号之后，I2C 总线将返回空闲状态。

起始信号和结束信号如下图所示

![image](https://wx4.sinaimg.cn/mw1024/ab20a024ly1g4kgbzk9k1j20kw0bxjru.jpg)


 - 3、有效的数据位传输

在 IIC 总线上传送的每一位数据都有一个时钟脉冲相对应(或同步控制)，即在 SCL 串行时钟的配合下，数据在 SDA 上从高位向低位依次串行传送每一位的数据。进行数据传送时，在 SCL 呈现高电平期间，SDA 上的电平必须保持稳定，低电平为数据 0，高电平为数据 1。只有在 SCL 为低电平期间，才允许 SDA 上的电平改变状态。下图是0xaa在IIC总线上有效传输(有效传输是指第9个时钟的高电平期间，从机给主机反馈了一个有效的应答位0)的图示

![image](https://wx4.sinaimg.cn/mw1024/ab20a024ly1g4kgbzjo5gj20ok0bpabh.jpg)


 - 4、应答信号与非应答信号

I2C 总线上的所有数据都是以 8 位字节传送的，发送器(主机)每发送一个字节，就在第9个时钟脉冲期间释放数据线（SDA被拉高），由接收器(从机)反馈一个应答信号。应答信号为低电平时，规定为有效应答位(ACK简称应答位)，表示接收器已经成功地接收了该字节；应答信号为高电平时，规定为非应答位(NACK)，一般表示接收器接收该字节没有成功。对于反馈有效应答位 ACK 的要求是，接收器在第 9 个时钟脉冲之前的低电平期间将 SDA 线拉低，并且确保在该时钟的高电平期间为稳定的低电平。

对非应答位(NACK)还要特别说明的是，还有以下四种情况IIC通信过程中会产生非应答位：

1、接收器(从机)正在处理某些实时的操作无法与主机实现IIC通信的时候，接收器(从机)会给主机反馈一个非应答位(NACK)

2、主机发送数据的过程中，从机无法解析发送的数据，接收器(从机)也会给主机反馈一个非应答位(NACK)

3、主机发送数据的过程中，从机无法再继续接收数据，接收器(从机)也会给主机反馈一个非应答位(NACK)

4、主机从从机中读取数据的过程中，主机不想再接收数据，主机会给从机反馈一个非应答位(NACK)，注意，这种情况是主机给从机反馈一个非应答位(NACK)

关于有效应答位的图示在上一传输0xaa的图中可以清楚的看到，关于非应答位的图示见下图

![image](https://wx1.sinaimg.cn/mw1024/ab20a024ly1g4kgf5cn2wj20pa08swfi.jpg)





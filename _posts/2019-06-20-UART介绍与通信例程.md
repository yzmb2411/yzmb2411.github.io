---
layout:     post
title:      UART介绍与通信例程
subtitle:   
date:       2019-06-20
author:     yzmb2411
header-img: 
catalog: 	 true
tags:
    - FPGA
    - 无线通信 
---

通用异步收发传输器（Universal Asynchronous Receiver/Transmitter)，通常称作UART，是一种异步收发传输器，是电脑硬件的一部分。它将要传输的资料在串行通信与并行通信之间加以转换。作为把并行输入信号转成串行输出信号的芯片，UART通常被集成于其他通讯接口的连结上。

UART是一种通用串行数据总线，用于异步通信。该总线双向通信，可以实现全双工传输和接收。在嵌入式设计中，UART用于主机与辅助设备通信，如汽车音响与外接AP之间的通信，与PC机通信包括与监控调试器和其它器件，如EEPROM通信。

计算机内部采用并行数据，不能直接把数据发到Modem(调制解调器)，必须经过UART整理才能进行异步传输，其过程为：CPU先把准备写入串行设备的数据放到UART的寄存器（临时内存块）中，再通过FIFO（First Input First Output，先入先出队列）传送到串行设备，若是没有FIFO，信息将变得杂乱无章，不可能传送到Modem。

UART工作原理是将传输数据的每个字符一位接一位地传输。

其中各位的意义如下：

 - 起始位：先发出一个逻辑”0”的信号，表示传输字符的开始。
 
 - 资料位：紧接着起始位之后。资料位的个数可以是4、5、6、7、8等，构成一个字符。通常采用ASCII码。从最低位开始传送，靠时钟定位。
 
 - 奇偶校验位：资料位加上这一位后，使得“1”的位数应为偶数(偶校验)或奇数(奇校验)，以此来校验资料传送的正确性。
 
 - 停止位：它是一个字符数据的结束标志。可以是1位、1.5位、2位的高电平。 由于数据是在传输线上定时的，并且每一个设备有其自己的时钟，很可能在通信中两台设备间出现了小小的不同步。因此停止位不仅仅是表示传输的结束，并且提供计算机校正时钟同步的机会。适用于停止位的位数越多，不同时钟同步的容忍程度越大，但是数据传输率同时也越慢。
 
 - 空闲位：处于逻辑“1”状态，表示当前线路上没有资料传送。
 
 - 波特率：是衡量资料传送速率的指标。表示每秒钟传送的符号数（symbol）。一个符号代表的信息量（比特数）与符号的阶数有关。例如资料传送速率为120字符/秒，传输使用256阶符号，每个符号代表8bit，则波特率就是120baud，比特率是120*8=960bit/s。这两者的概念很容易搞错。

在接收过程中，UART 从消息帧中去掉起始位和结束位，对进来的字节进行奇偶校验，并将数据字节从串行转换成并行。

UART传输时序如下图所示：

![image](https://wx2.sinaimg.cn/mw1024/ab20a024gy1g47mfer7pvj210m080diu.jpg)


## UART基本结构

 - (1)输出缓冲寄存器，它接收CPU从数据总线上送来的并行数据，并加以保存。
 
 - (2)输出移位寄存器，它接收从输出缓冲器送来的并行数据，以发送时钟的速率把数据逐位移出，即将并行数据转换为串行数据输出。
 
 - (3)输入移位寄存器，它以接收时钟的速率把出现在串行数据输入线上的数据逐位移入，当数据装满后，并行送往输入缓冲寄存器，即将串行数据转换成并行数据。
 
 - (4)输入缓冲寄存器，它从输入移位寄存器中接收并行数据，然后由CPU取走。
 
 - (5)控制寄存器，它接收CPU送来的控制字，由控制字的内容，决定通信时的传输方式以及数据格式等。例如采用异步方式还是同步方式，数据字符的位数，有无奇偶校验，是奇校验还是偶校验，停止位的位数等参数。
 
 - (6)状态寄存器。状态寄存器中存放着接口的各种状态信息，例如输出缓冲区是否空，输入字符是否准备好等。在通信过程中，当符合某种状态时，接口中的状态检测逻辑将状态寄存器的相应位置“1”，以便让CPU查询。
 
## 设计思想

 - 数据发送的思想是，当启动字节发送时，通过TxD先发起始位，然后发数据位和奇偶数校验位，最后再发停止位，发送过程由发送状态机控制，每次中断只发送1个位，经过若干个定时中断完成1个字节帧的发送。
 
 - 数据接收的思想是，当不在字节帧接收过程时，每次定时中断以3倍的波特率监视RxD的状态，当其连续3次采样电平依次为1、0、0时，就认为检测到了起始位，则开始启动一次字节帧接收，字节帧接收过程由接收状态机控制，每次中断只接收1个位，经过若干个定时中断完成1个字节帧的接收。
 
 - 为了提高串口的性能，在发送和接收上都实现了FIFO功能，提高通信的实时性。FIFO的长度可以进行自由定义，适应用户的不同需要。
 
波特率的计算按照计算公式进行，在设置最高波特率时一定要考虑模拟串口程序代码的执行时间，该定时时间必须大于模拟串口的程序的规定时间。单片机的执行速度越快，则可以实现更高的串口通讯速度。

## 工作原理

 - 发送数据过程：空闲状态，线路处于高电平；当收到发送指令后，拉低线路的一个数据位的时间T，接着数据按低位到高位依次发送，数据发送完毕后，接着发送奇偶校验位和停止位，一帧数据发送完成。
 
 - 数据接收过程：空闲状态，线路处于高电平；当检测到线路的下降沿（高电平变为低电平）时说明线路有数据传输，按照约定的波特率从低位到高位接收数据，数据接收完毕后，接着接收并比较奇偶校验位是否正确，如果正确则通知后续设备接收数据或存入缓冲。
 
 - 由于UART是异步传输，没有传输同步时钟，为了保证数据的正确性，UART采用16倍数据波特率的时钟进行采样。每个数据有16个时钟采样，取中间的采样值，以保证采样不会滑码或误码。一般UART一帧的数据位数为8，这样即使每个数据有一个时钟的误差，接收端也能正确地采样到数据。

UART的接收数据时序为：当检测到数据的下降沿时，表明线路上有数据进行传输，这时计数器CNT开始计数，当计数器为0时，产生起始位，当计数器为16时，采样的值为第0位数据；当计数器的值为32时，采样的值为第1位数据，依次类推，进行后面6个数据的采样。如果需要进行奇偶校验，则当计数器的值为144时，采样的值即为奇偶位；当计数器的值为160时，发送停止位，当计数器的值为168时，采样的值为“1”表示停止位，数据接收完成。

## 数据收发

发送时，数据被写入发送FIFO。如果UART 被使能，则会按照预先设置好的参数（波特率、数据位、停止位、校验位等）开始发送数据，一直到发送FIFO 中没有数据。一旦向发送FIFO 写数据（如果FIFO 未空），UART 的忙标志位BUSY 就有效，并且在发送数据期间一直保持有效。BUSY 位仅在发送FIFO 为空，且已从移位寄存器发送最后一个字符，包括停止位时才变无效。即 UART 不再使能，它也可以指示忙状态。BUSY 位的相关库函数是UARTBusy( )在UART 接收器空闲时，如果数据输入变成“低电平”，即接收到了起始位，则接收计数器开始运行，并且数据在Baud16 的第8 个周期被采样。如果Rx 在Baud16 的第8 周期仍然为低电平，则起始位有效，否则会被认为是错误的起始位并将其忽略。如果起始位有效，则根据数据字符被编程的长度，在 Baud16 的每第 16 个周期（即一个位周期之后）对连续的数据位进行采样。如果奇偶校验模式使能，则还会检测奇偶校验位。最后，如果Rx 为高电平，则有效的停止位被确认，否则发生帧错误。当接收到一个完整的字符时，将数据存放在接收FIFO 中。

## FIFO 操作

FIFO 是“First-In First-Out”的缩写，意为“先进先出”，是一种常见的队列操作。 Stellaris 系列ARM 的UART 模块包含有2 个16 字节的FIFO：一个用于发送，另一个用于接收。可以将两个FIFO 分别配置为以不同深度触发中断。可供选择的配置包括：1/8、 1/4、1/2、3/4 和7/8 深度。例如，如果接收FIFO 选择1/4，则在UART 接收到4 个数据时产生接收中断。
  
发送FIFO的基本工作过程： 只要有数据填充到发送FIFO 里，就会立即启动发送过程。由于发送本身是个相对缓慢的过程，因此在发送的同时其它需要发送的数据还可以继续填充到发送 FIFO 里。当发送 FIFO 被填满时就不能再继续填充了，否则会造成数据丢失，此时只能等待。这个等待并不会很久，以9600 的波特率为例，等待出现一个空位的时间在1ms 上下。发送 FIFO 会按照填入数据的先后顺序把数据一个个发送出去，直到发送 FIFO 全空时为止。已发送完毕的数据会被自动清除，在发送FIFO 里同时会多出一个空位。

接收FIFO的基本工作过程： 当硬件逻辑接收到数据时，就会往接收FIFO 里填充接收到的数据。程序应当及时取走这些数据，数据被取走也是在接收FIFO 里被自动删除的过程，因此在接收 FIFO 里同时会多出一个空位。如果在接收 FIFO 里的数据未被及时取走而造成接收FIFO 已满，则以后再接收到数据时因无空位可以填充而造成数据丢失。

收发FIFO 主要是为了解决UART 收发中断过于频繁而导致CPU 效率不高的问题而引入的。在进行 UART 通信时，中断方式比轮询方式要简便且效率高。但是，如果没有收发 FIFO，则每收发一个数据都要中断处理一次，效率仍然不够高。如果有了收发FIFO，则可以在连续收发若干个数据（可多至14 个）后才产生一次中断然后一并处理，这就大大提高了收发效率。

完全不必要担心FIFO 机制可能带来的数据丢失或得不到及时处理的问题，因为它已经帮你想到了收发过程中存在的任何问题，只要在初始化配置UART 后，就可以放心收发了， FIFO 和中断例程会自动搞定一切。

UART发送器的功能是按照基本UART帧格式把需要输出的并行数据先转化为TXD信号后再串行输出；UART接收器用于将接收到的RXD串行信号转化为并行数据；波特率发生器功能是为能对输入RXD不断采样，并且确保接收器和发送器保持同步，就需要波特率发生器专门产生一个远高于波特率的本地时钟信号来实现。

本串口通信例程的功能主要演示 AX516/AX545 开发板的 uart 接收和发送的功能，在程序没有接收到 PC 机发来信息的时候,串口会不断的通过串口向 PC 机发送” Hello ALINXAX516” 的信息。当用户从 PC 机发送数据给 AX516/AX545 开发板，程序接收到数据后会把数据从串口发回给 PC,从而实现 Loopback 的功能。串口通信例程包含一个 TOP 程序 uart_test.v 和四个子程序，四个子程序分别为串口发送程序 uarttx.v，串口接收程序 uartrx.v,时钟产生程序 clkdiv.v 和串口发送控制程序 uartctrl.v

程序对 50Mhz 的系统时钟进行分频，分频参数 326 计算如下：

这里产生的时钟 clkout 为波特率的 16 倍，假设数据的波特率为 p，则这里的时钟 clkout的频率为 16*p。以波特率 p 为 9600 为例，系统时钟为 50MHz，则分频系数为50000000/(16*9600) = 325.52，取整为 326。clkout 时钟取 16 倍波特率的目的为了在 uart 接收的时候对每比特接收的数据有 16 个时钟采样，取中间的采样值，以保证采样不会滑码或误码

发送数据过程：空闲状态，线路处于高电位；当收到发送数据指令后，拉低线路一个数据位的时间 T，接着数据按低位到高位依次发送，数据发送完毕后，接着发送奇偶校验位和停止位（停止位为高电位），一帧资料发送结束。

接收数据过程：空闲状态，线路处于高电位；当检测到线路的下降沿（线路电位由高电位变为低电位）时说明线路有数据传输，按照约定的波特率从低位到高位接收数据，数据接收完毕后，接着接收并比较奇偶校验位是否正确，如果正确则通知后续设备准备接收数据或存入缓存。

由于 UART 是异步传输，没有传输同步时钟。为了能保证数据传输的正确性，UART 采用16 倍数据波特率的时钟进行采样。每个数据有 16 个时钟采样，取中间的采样值，以保证采样不会滑码或误码。一般 UART 一帧的数据位数为 8，这样即使每个数据有一个时钟的误差，接收端也能正确地采样到数据

